@model IEnumerable<SIMS.Models.ViewModels.EnrollmentListViewModel>
@{
    ViewData["Title"] = "Manage Class Assignments";
}

<div class="page-header">
    <h2>
        <i class="bi bi-calendar-check"></i>
        Manage Class Assignments
    </h2>
    <p class="text-muted">Assign and manage students in classes</p>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-lightning-fill me-2"></i>
                Quick Actions
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <a asp-action="AssignStudents" class="btn btn-primary btn-lg w-100">
                            <i class="bi bi-person-plus-fill me-2"></i>
                            Assign Students to Class
                        </a>
                    </div>
                    <div class="col-md-6">
                        <a asp-action="BulkAssign" class="btn btn-warning btn-lg w-100">
                            <i class="bi bi-people-fill me-2"></i>
                            Bulk Assign by Department/Class
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label class="form-label"><i class="bi bi-calendar3 me-1"></i> Semester</label>
                <select name="semester" class="form-select" onchange="this.form.submit()">
                    <option value="">-- All --</option>
                    @foreach (var sem in ViewBag.Semesters as string[])
                    {
                        <option value="@sem" selected="@(ViewBag.Semester == sem)">@sem</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label"><i class="bi bi-calendar-range me-1"></i> Academic Year</label>
                <input type="text" name="academicYear" class="form-control" 
                       placeholder="2024-2025" value="@ViewBag.AcademicYear">
            </div>
            <div class="col-md-4">
                <label class="form-label"><i class="bi bi-book me-1"></i> Course</label>
                <select name="courseId" class="form-select" asp-items="ViewBag.Courses">
                    <option value="">-- All --</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2 w-100">
                    <i class="bi bi-search"></i> Filter
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <i class="bi bi-list-ul me-2"></i>
        Assignment List (@Model.Count())
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th><i class="bi bi-person me-1"></i> Student ID</th>
                        <th>Full Name</th>
                        <th><i class="bi bi-book me-1"></i> Course</th>
                        <th><i class="bi bi-calendar me-1"></i> Semester</th>
                        <th>Status</th>
                        <th>Average</th>
                        <th>Assigned By</th>
                        <th>Assigned Date</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (!Model.Any())
                    {
                        <tr>
                            <td colspan="10" class="text-center text-muted py-4">
                                <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                                <p class="mb-0 mt-2">No assignments yet</p>
                            </td>
                        </tr>
                    }
                    else
                    {
                        int stt = 1;
                        foreach (var item in Model)
                        {
                            <tr>
                                <td>@stt</td>
                                <td><strong class="text-navy">@item.StudentCode</strong></td>
                                <td>@item.StudentName</td>
                                <td>
                                    <strong>@item.CourseCode</strong> - @item.CourseName
                                </td>
                                <td>
                                    <span class="badge bg-info">@item.Semester</span>
                                    <small class="text-muted">@item.AcademicYear</small>
                                </td>
                                <td>
                                    @if (item.Status == "Active")
                                    {
                                        <span class="badge bg-success">Active</span>
                                    }
                                    else if (item.Status == "Completed")
                                    {
                                        <span class="badge bg-primary">Completed</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Dropped</span>
                                    }
                                </td>
                                <td>
                                    @if (item.AverageScore.HasValue)
                                    {
                                        <strong class="text-primary">@item.AverageScore.Value.ToString("F2")</strong>
                                        <small class="text-muted">(@item.LetterGrade)</small>
                                    }
                                    else
                                    {
                                        <span class="text-muted">No Grade</span>
                                    }
                                </td>
                                <td>
                                    <small class="text-muted">@item.AssignedBy</small>
                                </td>
                                <td>
                                    <small>@item.AssignedDate.ToString("dd/MM/yyyy")</small>
                                </td>
                                <td class="text-center">
                                    <!-- Xem chi tiết lớp -->
                                    @if (item.ScheduleId.HasValue)
                                    {
                                        <a asp-action="ViewClassDetails" 
                                           asp-route-scheduleId="@item.ScheduleId" 
                                           asp-route-semester="@item.Semester"
                                           asp-route-academicYear="@item.AcademicYear"
                                           class="btn btn-sm btn-outline-info me-1" 
                                           title="View Class Details">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                    }
                                    
                                    <!-- Remove Enrollment -->
                                    <form asp-action="RemoveEnrollment" asp-route-id="@item.Id" 
                                          method="post" class="d-inline"
                                          onsubmit="return confirm('Delete this assignment?');">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete Assignment">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            stt++;
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="card mt-3">
    <div class="card-header bg-info text-white">
        <i class="bi bi-info-circle me-2"></i>
        Guidelines
    </div>
    <div class="card-body">
        <ul class="mb-0">
            <li><strong>Assign Students:</strong> Select specific students to assign to class</li>
            <li><strong>Bulk Assign:</strong> Assign all students by department/class to course</li>
            <li><strong>Delete Assignment:</strong> Can only delete when student has no grades</li>
        </ul>
    </div>
</div>
