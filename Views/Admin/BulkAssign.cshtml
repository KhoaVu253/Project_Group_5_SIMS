@model SIMS.Models.ViewModels.BulkAssignViewModel
@{
    ViewData["Title"] = "Bulk Assignment";
}

<div class="page-header">
    <h2>
        <i class="bi bi-people-fill"></i>
        Bulk Assignment by Department/Class
    </h2>
    <p class="text-muted">Assign all students of a department/class to a specific class</p>
</div>

<div class="row">
    <div class="col-md-10 offset-md-1">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Bulk Assignment
            </div>
            <div class="card-body">
                <div class="alert alert-warning" role="alert">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Note:</strong> This function will assign all active students
                    of the selected department/class to the course. Please check carefully before proceeding!
                </div>

                <form asp-action="BulkAssign" method="post" id="bulkAssignForm">
                    @Html.AntiForgeryToken()
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                    <div class="row g-3">
                        <!-- Môn học -->
                        <div class="col-md-12">
                            <label asp-for="CourseId" class="form-label">
                                <i class="bi bi-book me-1"></i>
                                Course <span class="text-danger">*</span>
                            </label>
                            <select asp-for="CourseId" class="form-select" asp-items="ViewBag.Courses" id="courseSelect">
                                <option value="">-- Select Course --</option>
                            </select>
                            <span asp-validation-for="CourseId" class="text-danger"></span>
                        </div>

                        <!-- Học kỳ và Năm học -->
                        <div class="col-md-6">
                            <label asp-for="Semester" class="form-label">
                                <i class="bi bi-calendar3 me-1"></i>
                                Semester <span class="text-danger">*</span>
                            </label>
                            <select asp-for="Semester" class="form-select" id="semesterSelect">
                                @foreach (var sem in ViewBag.Semesters as string[])
                                {
                                    <option value="@sem">@sem</option>
                                }
                            </select>
                            <span asp-validation-for="Semester" class="text-danger"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="AcademicYear" class="form-label">
                                <i class="bi bi-calendar-range me-1"></i>
                                Academic Year <span class="text-danger">*</span>
                            </label>
                            <input asp-for="AcademicYear" class="form-control" id="academicYearInput" placeholder="2024-2025" />
                            <span asp-validation-for="AcademicYear" class="text-danger"></span>
                        </div>

                        <!-- ✅ NEW: Lớp học (CourseSchedule) -->
                        <div class="col-md-12">
                            <label asp-for="ScheduleId" class="form-label">
                                <i class="bi bi-calendar-week me-1"></i>
                                Class <span class="text-danger">*</span>
                            </label>
                            <select asp-for="ScheduleId" class="form-select" id="scheduleSelect" disabled>
                                <option value="">-- Select course first --</option>
                            </select>
                            <span asp-validation-for="ScheduleId" class="text-danger"></span>
                            <small class="text-muted">Select class with specific faculty, time, and room</small>
                        </div>

                        <!-- Khoa -->
                        <div class="col-md-6">
                            <label asp-for="Department" class="form-label">
                                <i class="bi bi-building me-1"></i>
                                Department <span class="text-danger">*</span>
                            </label>
                            <select asp-for="Department" class="form-select">
                                <option value="">-- Select Department --</option>
                                @foreach (var dept in ViewBag.Departments as string[])
                                {
                                    <option value="@dept">@dept</option>
                                }
                            </select>
                            <span asp-validation-for="Department" class="text-danger"></span>
                            <small class="text-muted">Required: Select department to assign</small>
                        </div>

                        <!-- Lớp sinh viên -->
                        <div class="col-md-6">
                            <label asp-for="ClassName" class="form-label">
                                <i class="bi bi-door-open me-1"></i>
                                Class (Optional)
                            </label>
                            <input asp-for="ClassName" class="form-control" placeholder="E.g: 21IT1" />
                            <span asp-validation-for="ClassName" class="text-danger"></span>
                            <small class="text-muted">Leave empty = all classes in department</small>
                        </div>

                        <!-- Ghi chú -->
                        <div class="col-md-12">
                            <label asp-for="Notes" class="form-label">
                                <i class="bi bi-sticky me-1"></i>
                                Notes
                            </label>
                            <textarea asp-for="Notes" class="form-control" rows="3" 
                                      placeholder="Notes about this assignment (optional)"></textarea>
                            <span asp-validation-for="Notes" class="text-danger"></span>
                        </div>

                        <!-- Buttons -->
                        <div class="col-12">
                            <hr />
                            <button type="submit" class="btn btn-warning btn-lg" 
                                    onclick="return confirm('Are you sure you want to perform bulk assignment? This action will affect many students!');">
                                <i class="bi bi-lightning-fill"></i> Bulk Assign
                            </button>
                            <a asp-action="ManageEnrollments" class="btn btn-secondary btn-lg">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header bg-info text-white">
                <i class="bi bi-lightbulb me-2"></i>
                Usage Examples
            </div>
            <div class="card-body">
                <h6>Example 1: Assign entire IT Department to IT101 - C# Programming class</h6>
                <ul>
                    <li>Course: C# Programming</li>
                    <li>Semester: HK1 - 2024-2025</li>
                    <li><strong>Class: Monday, Period 1-3, Room A102 (Faculty: Nguyen Van A)</strong></li>
                    <li>Department: Information Technology</li>
                    <li>Class: <em>(leave empty)</em></li>
                    <li>→ All IT department students will be assigned to this class</li>
                </ul>

                <h6 class="mt-3">Example 2: Assign class 21IT1 to specific class</h6>
                <ul>
                    <li>Course: Database</li>
                    <li>Semester: HK1 - 2024-2025</li>
                    <li><strong>Class: Wednesday, Period 7-9, Room B205 (Faculty: Tran Thi B)</strong></li>
                    <li>Department: Information Technology</li>
                    <li>Class: 21IT1</li>
                    <li>→ Only students from class 21IT1 will be assigned to this class</li>
                </ul>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        $(document).ready(function() {
            var courseSelect = $('#courseSelect');
            var semesterSelect = $('#semesterSelect');
            var academicYearInput = $('#academicYearInput');
            var scheduleSelect = $('#scheduleSelect');

            // Load schedules when course, semester, or academic year changes
            function loadSchedules() {
                var courseId = courseSelect.val();
                var semester = semesterSelect.val();
                var academicYear = academicYearInput.val();

                if (!courseId || !semester || !academicYear) {
                    scheduleSelect.html('<option value="">-- Please select course, semester and academic year --</option>');
                    scheduleSelect.prop('disabled', true);
                    return;
                }

                scheduleSelect.html('<option value="">Loading...</option>');
                scheduleSelect.prop('disabled', true);

                $.ajax({
                    url: '@Url.Action("GetCourseSchedules", "Admin")',
                    type: 'GET',
                    data: {
                        courseId: courseId,
                        semester: semester,
                        academicYear: academicYear
                    },
                    success: function(schedules) {
                        scheduleSelect.empty();
                        
                        if (schedules.length === 0) {
                            scheduleSelect.append('<option value="">-- No classes available --</option>');
                        } else {
                            scheduleSelect.append('<option value="">-- Select Class --</option>');
                            
                            $.each(schedules, function(index, schedule) {
                                var displayText = schedule.dayName + ', ' + 
                                                schedule.periodRange + ' (' + schedule.timeRange + '), ' +
                                                'Room ' + schedule.room + ' - Faculty: ' + schedule.facultyName;
                                
                                scheduleSelect.append(
                                    $('<option></option>')
                                        .val(schedule.scheduleId)
                                        .text(displayText)
                                );
                            });
                            
                            scheduleSelect.prop('disabled', false);
                        }
                    },
                    error: function() {
                        scheduleSelect.html('<option value="">Error loading schedule</option>');
                        alert('Unable to load schedule list. Please try again!');
                    }
                });
            }

            // Event listeners
            courseSelect.change(loadSchedules);
            semesterSelect.change(loadSchedules);
            academicYearInput.blur(loadSchedules);

            // Load schedules on page load if values are set
            if (courseSelect.val() && semesterSelect.val() && academicYearInput.val()) {
                loadSchedules();
            }
        });
    </script>
}
